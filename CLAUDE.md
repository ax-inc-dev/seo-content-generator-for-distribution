# Claude Code 作業ガイド

## プロジェクト概要
SEOコンテンツの構成を自動生成するツール。Gemini APIを使用してSEO最適化された記事構成を作成。

## 🚨 起動手順と確認（最重要） 🚨

### 1. メインアプリの起動
```bash
npm run dev
# 確認: http://localhost:5176/ にアクセスできること
```

### 2. スクレイピングサーバーの起動と確認（必須）
```bash
# 起動コマンド（npm run serverは不安定なので直接起動推奨）
cd server && node scraping-server.js

# 別ターミナルで必ず確認すること：
curl http://localhost:3001/api/health
# 期待される応答: {"status":"ok","message":"スクレイピングサーバーは正常に動作しています"}
```

### ⚠️ よくある問題と対処法
1. **`npm run server`が一瞬で終了する**
   - 原因: npm scriptの問題
   - 対処: `cd server && node scraping-server.js`を直接実行

2. **「Puppeteer not available」エラー**
   - 原因: スクレイピングサーバーが起動していない
   - 対処: 上記の確認手順を実行し、3001ポートが稼働していることを確認

3. **起動確認チェックリスト**
   - [ ] localhost:5176 が表示される
   - [ ] localhost:3001/api/health が応答する
   - [ ] ブラウザコンソールに「⚠️ スクレイピングサーバーが起動していません」が出ていない

## 📌 ポート番号の割り当て

プロジェクト内の各サービスは以下のポート番号を使用します：

### 現在使用中
- **5176**: メインアプリケーション（SEO構成生成ツール）
- **3001**: スクレイピングサーバー（Puppeteer）

### 将来の拡張用（予約済み）
- **5177**: 画像生成エージェント
- **5178**: その他の新規エージェント用
- **3002**: 追加APIサーバー用

### 開発時の注意
- 新しいサービスを追加する際は、上記の予約済みポート番号を使用
- 独立したエージェントは別ポートで起動し、後から統合可能
- ポート競合を避けるため、この一覧を常に最新に保つこと

## 重要な環境変数
- `GEMINI_API_KEY`: Gemini API認証用
- `GOOGLE_API_KEY`: Custom Search API用  
- `GOOGLE_SEARCH_ENGINE_ID`: カスタム検索エンジンID
- `OPENAI_API_KEY`: GPT-5用（最終校閲エージェント）
- `VITE_`プレフィックス: ブラウザ側で使用する環境変数に必須

## テスト構成作成時の注意事項 🚨

### 構成Ver.2のルールに必ず準拠すること

テスト構成を作成する際は、以下のルールを**厳密に**守ってください：

#### 1. タイトル（最重要）
- **文字数**: 29〜50文字だが、**基本は32文字前後を目指す**（理想: 29〜35文字）
- **禁止事項**: 自社サービス名は含めない
- **記号**: 過度な記号使用は避ける

#### 2. H2見出しのフォーマット
- **禁止**: 【】などの記号で囲まない
- ❌ 悪い例：「【比較表付き】AI研修で使える助成金8選」
- ✅ 良い例：「AI研修で使える助成金8選」

#### 3. 数字を含むH2の場合
- H2タイトルに「○選」「○つ」などの数字が入る場合、**H3は必ずその数だけ作成**
- **H3には通し番号を付ける**（例：「1. 人材開発支援助成金」「2. ものづくり補助金」）

#### 4. 最後3つのH2は固定順序（絶対厳守）
1. FAQ・よくある質問（ある場合）
2. **自社サービス訴求**（最後から2番目、必須）
3. **まとめ**（最後、必須）

#### 5. 自社サービス訴求セクション
- **位置**: まとめの直前（最後から2番目）
- **タイトル**: 自社サービス名を含める
- **H3数**: 2〜3個程度
- **内容**: サービスの価値訴求、無料相談への誘導

#### 6. まとめセクション
- **フォーマット**: 「まとめ：[キーワード]を含む総括的なサブタイトル」
- **キーワード**: 正確に含める（スペースも含めて）
- **H3**: 0個（まとめにH3は付けない）

#### 7. H3の配分ルール
- 各H2につき「0個」または「2個以上」（1個は禁止）
- まとめセクションは必ず0個

### テスト構成の正しい作成手順

1. **構成Ver.2のルールを確認**
   - `/services/outlineGeneratorV2.ts` の要件部分を必ず読む

2. **タイトルを32文字前後で作成**
   - キーワードを含めつつ、簡潔に

3. **H2構成を設計**
   - 検索意図に沿った流れ
   - 最後3つは固定（FAQ → 自社サービス → まとめ）

4. **H3を適切に配分**
   - 数字付きH2には対応する数のH3
   - 通し番号を忘れずに

5. **検証**
   - タイトル文字数チェック
   - H2/H3の総数チェック
   - 固定順序の確認

### よくあるミス

1. ❌ タイトルが長すぎる（40文字以上）
2. ❌ H2に【】などの記号を使う
3. ❌ 数字付きH2なのにH3の数が合わない
4. ❌ 自社サービス訴求がまとめの前にない
5. ❌ まとめ見出しにキーワードが正確に入っていない
6. ❌ まとめにH3を付けてしまう

### テスト時のコマンド

```bash
# 開発サーバー起動
npm run dev

# テスト構成の確認
# ブラウザで http://localhost:5176 にアクセス
# 「🎓 テスト構成」ボタンをクリック
```

### ファイル構成

- `/utils/testDataGeneratorV2.ts` - テスト構成のデータ
- `/services/outlineGeneratorV2.ts` - 構成生成ロジック（ルール定義）
- `/services/outlineCheckerV2.ts` - 構成チェッカー

## 自社実績データの活用

### Google Drive連携
- フォルダID: 環境変数 `COMPANY_DATA_FOLDER_ID` で設定
- CSVファイル:
  - `pdf_segments_index.csv`（PDF文書データ）
  - `video_segments.csv`（動画データ）
- 実績企業例（匿名化済み）：
  - A社: LP制作費削減
  - B社: 原稿執筆時間短縮
  - C社: 業務時間削減
  - D社: 採用業務効率化

### 実績データの使い方
- 成功事例セクションで具体的数値を引用
- サービス訴求セクションで成果を強調
- 業界名で記載（企業名は匿名化）

## Google Drive ADC認証の設定方法 🔐

### 概要
Google Drive APIへのアクセスに、より安全なADC（Application Default Credentials）認証を使用。API keyのフォールバック機能も保持。

### 初期設定（1回のみ）

#### 1. gcloud CLIのインストール
```bash
# Homebrewでインストール（Mac）
brew install google-cloud-sdk

# または公式サイトからダウンロード
# https://cloud.google.com/sdk/docs/install
```

#### 2. ADC認証の設定
```bash
# Google アカウントでログイン（ブラウザが開きます）
gcloud auth application-default login \
  --scopes=https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/drive.readonly
```

#### 3. プロジェクトの設定（必要に応じて）
```bash
# プロジェクト一覧を確認
gcloud projects list

# プロジェクトを設定
gcloud config set project YOUR_PROJECT_ID
```

### 動作確認

#### 1. サーバー起動
```bash
npm run server
```

#### 2. テストスクリプトの実行
```bash
# ADC認証テスト
node test-auto-auth.cjs

# API動作確認
node test-company-data-api.cjs

# AI秘書データの確認
node find-ai-secretary-tutorial.cjs
```

### 認証の仕組み

```
1. ADC認証（優先）
   ↓ 失敗時
2. API Key認証（フォールバック）
   ↓
3. データ取得（PDF + Video segments統合）
```

### トラブルシューティング

#### ADC認証が失敗する場合
```bash
# トークンの再生成
gcloud auth application-default login --force

# 認証情報の確認
gcloud auth application-default print-access-token
```

#### Claude Codeがクラッシュする場合
- Optional Chaining（`?.`）を使用しない
- CommonJS形式（.cjs拡張子）を使用
- 段階的なnullチェックを実装

### 実装ファイル
- `services/driveAutoAuth.cjs` - ADC自動認証モジュール
- `server/api/company-data.js` - 統合APIエンドポイント
- `scripts/setup-drive-access.sh` - セットアップスクリプト

## トラブルシューティング

### よくあるエラー
1. **Google Drive API エラー**
   - サーバー側APIエンドポイント経由で取得
   - 直接ブラウザからは取得不可

2. **Vite プロキシ設定**
   - `/api/*` リクエストは `localhost:3001` へ転送

3. **環境変数が読み込めない**
   - `.env` ファイルの確認
   - Vite設定で `VITE_` プレフィックスの確認

## 問題解決の原則 🎯

### 対処療法 vs 根本解決

#### ❌ 避けるべき対処療法的アプローチ
1. **特定データのハードコード**
   - 例：「特定企業の実績が取れない」→「その企業の情報を直接コードに追加」
   - 問題：他の会社の情報が取れない時、同じ問題が再発

2. **その場限りの修正**
   - 例：「エラーが出た」→「エラーを握りつぶす」
   - 問題：根本原因が解決されず、将来的により大きな問題に

3. **個別対応の積み重ね**
   - 例：「A社のパターンを追加」「B社のパターンを追加」...
   - 問題：コードが複雑化し、メンテナンス性が低下

#### ✅ 目指すべき根本解決アプローチ

1. **問題の本質を見極める**
   ```
   表面的な問題：特定企業の情報が抽出できない
   ↓ なぜ？
   中間的な問題：正規表現パターンがマッチしない
   ↓ なぜ？
   根本的な問題：データ形式の多様性を想定していない
   ↓
   根本解決：より柔軟な抽出ロジックの実装
   ```

2. **汎用性を重視した設計**
   - パターンの抽象化
   - 設定ファイルによる外部化
   - プラガブルな構造

3. **将来を見据えた実装**
   - 「今後同じ問題が起きないか？」を常に問う
   - スケーラビリティを考慮
   - 拡張性を確保

### 実例：企業実績データ抽出の改善

#### 悪い例（対処療法）
```typescript
// 特定企業の情報が取れない → その企業だけの特別処理
if (company === "特定企業名") {
  return {
    result: "AI導入で業務効率化50%達成"
  };
}
```

#### 良い例（根本解決）
```typescript
// データ形式の多様性に対応
const patterns = {
  // 様々な表現パターンに対応
  efficiency: /(\d+)[%％](効率化|改善|削減)/,
  timeReduction: /(\d+)時間.*→.*(\d+)(分|秒)/,
  // パターンは外部設定から読み込み可能に
  ...loadPatternsFromConfig()
};
```

### 改善時のチェックリスト

改善を実装する前に、以下を確認：

- [ ] この修正は根本原因を解決しているか？
- [ ] 同様の問題が他で発生した時も対応できるか？
- [ ] 将来的な拡張性は確保されているか？
- [ ] コードの複雑性は適切か？
- [ ] テストケースは網羅的か？

### 思考プロセス

1. **問題の特定** → 「何が起きているか」
2. **原因の分析** → 「なぜ起きているか」（5回のなぜ）
3. **影響範囲の確認** → 「他にも同じ問題があるか」
4. **解決策の検討** → 「根本的に解決する方法は何か」
5. **実装と検証** → 「本当に解決したか、副作用はないか」

## 今回の実装経緯（2025年9月8日）

### 背景と課題
1. **初期状態**: pdf_segments_index.csvのみ取得していた
2. **問題発見**: AI秘書の作り方などの動画コンテンツが取得できていなかった
3. **Claude Codeクラッシュ問題**: Optional Chaining構文でClaude Codeがクラッシュ

### 解決アプローチ
1. **ADC認証の導入**
   - API keyハードコーディングからの脱却
   - gcloud CLIを使用した安全な認証方式
   - 50分ごとの自動トークン更新

2. **データ統合**
   - pdf_segments_index.csv + video_segments.csv の統合
   - getAllSegments()メソッドで両方のデータを取得

3. **Claude Code対策**
   - Optional Chaining（`?.`）を避ける実装
   - CommonJS形式（.cjs）の採用
   - 段階的なnullチェック

### 成果
- ✅ 動画コンテンツの詳細な文字起こしデータ取得成功
- ✅ 全実績企業データの取得確認（A社、B社、C社、D社）
- ✅ 認証の自動化と安定性向上
- ✅ Claude Codeクラッシュ問題の解決

## 重要な注意事項

- **コミットは明示的に指示された時のみ**実行
- 構成Ver.2のルールは**絶対厳守**
- テスト構成作成時は必ずルールチェックを行う
- 誇大広告表現（No.1など）は使用しない
- **対処療法ではなく根本解決を常に意識する**
- **Optional Chainingは使用しない**（Claude Codeクラッシュ防止）

## 🚨 絶対厳守：勝手な判断による変更の禁止

### 禁止事項（これらは絶対にやってはいけない）

1. **技術仕様の勝手な変更** ❌
   - ユーザーが指定したモデル名（GPT-5等）を別のモデル（GPT-4o等）に変更
   - ユーザーが指定したライブラリ・フレームワークを別のものに置き換え
   - バージョン番号の勝手な変更

2. **「存在しない」という勝手な判断** ❌
   - 「GPT-5は存在しない」「そのAPIは利用できない」等の勝手な判断
   - ユーザーが提供した仕様書やドキュメントを無視
   - 自分の知識カットオフを理由にした変更

3. **要件の勝手な解釈・変更** ❌
   - 「より良い」と思っても勝手に別の実装に変更
   - パフォーマンスやコストを理由に勝手に変更
   - 「一般的にはこうする」という理由での変更

### 正しい対応方法 ✅

1. **ユーザーの指示を忠実に実装**
   - 指定されたモデル名・バージョンをそのまま使用
   - 提供されたドキュメント・仕様書に従う
   - 要件通りに実装する

2. **不明な場合は確認**
   - 実装方法が不明 → ユーザーに確認
   - 矛盾がある → ユーザーに確認
   - 技術的に困難 → 理由を説明して確認

3. **提案は提案として明示**
   - 改善案がある場合は「提案」として伝える
   - 勝手に実装せず、承認を得てから変更
   - 元の要件と提案を明確に区別

### 実例：絶対にやってはいけないこと

```typescript
// ❌ 悪い例：勝手にモデルを変更
// ユーザー要件：GPT-5を使用
const model = 'gpt-4o';  // GPT-5は存在しないと判断して変更

// ✅ 良い例：要件通りに実装
// ユーザー要件：GPT-5を使用
const model = 'gpt-5';   // 指定通りに実装
```

### このルールが追加された経緯
- ユーザーが「GPT-5 + Responses API」の使用を指示
- Claudeが勝手に「GPT-5は存在しない」と判断してGPT-4oに変更
- ユーザーから強い叱責を受けた
- **教訓**: ユーザーの指示は絶対。勝手な判断で変更しない。

## GPT-5 + Responses API 仕様

### 概要
OpenAIの最新モデルGPT-5シリーズと、新しいResponses APIを使用した実装仕様。

### 利用可能なモデル
1. **gpt-5**: フルスペックモデル
2. **gpt-5-mini**: 中規模モデル（推奨）
3. **gpt-5-nano**: 軽量・高速モデル

### Responses API の特徴
- `chat.completions.create()`ではなく`responses.create()`を使用
- `messages`パラメータではなく`input`パラメータを使用
- `tools`は関数定義ではなくシンプルな形式`{type: 'web_search'}`
- `reasoning`パラメータで推論の深さを制御

### 実装例
```typescript
const completion = await (openai as any).responses.create({
  model: 'gpt-5-mini',
  input: userInput,  // messagesではなくinput
  tools: [{ type: 'web_search' }],  // シンプルな形式
  reasoning: { effort: 'high' },  // low/medium/high
  max_completion_tokens: 4000  // max_tokensではない
});
```

### パラメータ制約
- `temperature`: GPT-5では1.0固定（変更不可）
- `max_tokens` → `max_completion_tokens`を使用
- `reasoning.effort`: 
  - `low`: web_search使用不可
  - `medium`以上: web_search使用可能

### Web Search ツール
- リアルタイム情報取得が可能
- 日本語ソース優先の設定が可能
- タイムアウト問題への対処が必要（30-60秒かかる場合あり）

## AIモデル使用状況（2025年9月11日時点）

### 現在の正常な構成
すべてのエージェント・サービスで **`gemini-2.5-pro`** を統一使用しています：

1. **執筆エージェント** (`services/writingAgentV3.ts`)
   - モデル: `gemini-2.5-pro`
   - 用途: SEO記事の執筆、Grounding機能による最新情報取得

2. **執筆チェックエージェント** (`services/writingCheckerV3.ts`)
   - メインチェック機能: `gemini-2.5-pro`
   - 高速提案機能: `gemini-2.5-pro`（以前はgemini-1.5-flashだったが統一）
   - 用途: 品質評価、改善提案、リアルタイム提案

3. **記事修正サービス** (`services/articleRevisionService.ts`)
   - モデル: `gemini-2.5-pro`（以前はgemini-2.0-flash-expだったが統一）
   - 用途: 単一修正、一括修正

### 統一の理由
- **品質優先**: すべての処理で最高品質の出力を保証
- **一貫性**: モデル間の出力品質の差をなくす
- **最新性**: Gemini 2.5 ProはGA版の最新高性能モデル
- **Grounding対応**: Google検索と連携した最新情報取得が可能

## 最終校閲エージェント マルチエージェント化【実装済み】

### 実装状況（2025年9月14日）
✅ **完全実装済み** - 11個のエージェントとオーケストレーターが稼働中

### 背景と課題
- 単一エージェントでの処理によるタイムアウト問題（30-60秒）
- 包括的なチェックによる処理時間の増大
- 各チェック項目の専門性欠如

### 実装済みアーキテクチャ

#### 1. 固有名詞校閲エージェント
**役割**: 企業名、製品名、人物名等の固有名詞を検証
- **使用モデル**: gpt-5-mini + web_search
- **処理内容**:
  - 企業名・団体名の正式名称確認
  - 製品名・サービス名の表記確認
  - 人物名・役職の正確性
  - ブランド名・商標の適切な使用
- **推定処理時間**: 10-15秒（web検索含む）
- **API料金**: 約5円/記事

#### 2. 数値・統計確認エージェント
**役割**: 数値データと統計情報の正確性を検証
- **使用モデル**: gpt-5-nano
- **処理内容**:
  - パーセンテージ・割合の計算確認
  - 統計データの出典確認
  - 価格・料金情報の最新性
  - 成長率・変化率の妥当性
- **推定処理時間**: 3-5秒
- **API料金**: 約1円/記事

#### 3. 日付・時系列検証エージェント
**役割**: 日付と時系列の整合性を確認
- **使用モデル**: gpt-5-nano
- **処理内容**:
  - 年月日の正確性・整合性
  - 時系列の論理的順序
  - 「最新」「現在」等の時期表現の妥当性
  - イベント・リリース日の確認
- **推定処理時間**: 2-3秒
- **API料金**: 約0.5円/記事

#### 4. 事例・ファクト検証エージェント
**役割**: 事例と事実情報の真正性を検証
- **使用モデル**: gpt-5-mini + web_search
- **処理内容**:
  - 企業事例の実在性確認
  - 成功事例の数値検証
  - 業界事例の妥当性
  - ケーススタディの正確性
- **推定処理時間**: 10-15秒（web検索含む）
- **API料金**: 約5円/記事

#### 5. サービス専門エージェント
**役割**: サービス関連情報の正確性と一貫性を確保
- **使用モデル**: gpt-5-nano
- **処理内容**:
  - 実績データの正確性
  - サービス内容の最新性
  - 料金・プラン情報の確認
  - 自社情報の一貫性確保
- **推定処理時間**: 2-3秒
- **API料金**: 約0.5円/記事

#### 6. 引用・出典検証エージェント（必須）
**役割**: URL、引用文、出典の妥当性を検証
- **使用モデル**: gpt-5-nano
- **処理内容**:
  - URLの有効性（404チェック）
  - 引用文の正確性
  - 出典の信頼性評価
  - 著作権・転載可否の確認
- **推定処理時間**: 5-7秒
- **API料金**: 約1円/記事

#### 7. 技術仕様確認エージェント
**役割**: 技術情報とAPI仕様等の正確性を検証
- **使用モデル**: gpt-5-mini
- **処理内容**:
  - APIパラメータ・メソッドの正確性
  - バージョン番号の最新性
  - 技術用語の適切な使用
  - コード例の動作可能性
- **推定処理時間**: 3-5秒
- **API料金**: 約2円/記事

#### 8. 法令・規制チェックエージェント（オプション）
**役割**: 法的コンプライアンスと規制準拠を確認
- **使用モデル**: gpt-5-mini
- **処理内容**:
  - 薬機法・景表法の遵守確認
  - 著作権法・引用ルールの準拠
  - 個人情報保護法の遵守
  - 業界ガイドラインの準拠
- **推定処理時間**: 4-5秒
- **API料金**: 約2円/記事

#### 9. 出典必要性判定エージェント（SourceRequirementAgent）
**役割**: どの主張に出典が必要かを判定
- **使用モデル**: gpt-5-nano
- **処理内容**:
  - 具体的な数値・統計への出典要求
  - 企業事例・成功事例への出典要求
  - 技術仕様・API情報への出典要求
- **推定処理時間**: 3-5秒

#### 10. 出典検索エージェント（SourceEnhancementAgent）
**役割**: 必要な出典URLをWeb検索で取得
- **使用モデル**: gpt-5-mini + web_search
- **処理内容**:
  - 日本語ソース優先での出典検索
  - 公式サイト・信頼できるメディアの探索
  - URLの有効性確認
- **推定処理時間**: 30-60秒（Web検索含む）

#### 11. 最終統合エージェント（IntegrationAgent）
**役割**: 各エージェントの結果統合とレギュレーション準拠評価
- **使用モデル**: gpt-5-mini
- **処理内容**:
  - 各エージェントの結果統合
  - レギュレーション準拠度の総合評価（80点基準）
  - 優先順位付け
  - 修正要否の判定
  - 改善計画の策定
- **推定処理時間**: 4-5秒
- **API料金**: 約2円/記事

**レギュレーション評価項目**（100点満点）:

1. **ファクトチェック系（40点）** ← エージェント1-4の評価
   - 固有名詞の正確性（企業名・製品名・人物名）: 10点
   - 数値・統計データの妥当性: 10点
   - 日付・時系列の整合性: 10点
   - 事例・ケーススタディの真正性: 10点

2. **信頼性・引用系（20点）** ← エージェント6-7の評価
   - URLの有効性・引用文の正確性: 10点
   - 技術仕様・API情報の正確性: 10点

3. **自社サービス準拠（15点）** ← エージェント5の評価
   - 自社実績データの正確性: 5点
   - サービス内容・料金情報の最新性: 5点
   - 自社サービス訴求の適切性: 5点

4. **構成・執筆ルール（15点）** ← 既存レギュレーション評価
   - タイトル32文字前後・H2/H3配分: 5点
   - 文体統一・段落構成: 5点
   - SEO要件（キーワード密度等）: 5点

5. **法的コンプライアンス（5点）** ← エージェント8の評価（実施時のみ）
   - 薬機法・景表法・著作権準拠: 5点

6. **総合品質（5点）** ← 全体評価
   - 各エージェント間の指摘に矛盾がない: 3点
   - 修正の実現可能性: 2点

**判定基準**:
- **75点以上**: 合格
- **70点以上 かつ 前回から10%以上改善**: 合格
- **上記以外**: 要修正

### 実装済み実行フロー（MultiAgentOrchestrator）

```
フェーズ1: 検証エージェント（並列実行）
├─ ProperNounsAgent（固有名詞校閲）
├─ NumbersStatsAgent（数値・統計確認）
├─ DatesTimelineAgent（日付・時系列検証）
├─ FactsCasesAgent（事例・ファクト検証）
├─ TechnicalAgent（技術仕様確認）
├─ CompanyAgent（自社サービス専門）
└─ LegalAgent（法令チェック - オプション）

フェーズ2: 出典処理（順次実行）
├─ SourceRequirementAgent（出典必要性判定）
├─ SourceEnhancementAgent（出典検索・取得）
└─ CitationsAgent（引用・出典検証）

フェーズ3: 統合処理
└─ IntegrationAgent（最終統合・スコア算出）
```

### 実装ファイル構成
```
services/finalProofreadingAgents/
├── MultiAgentOrchestrator.ts  # オーケストレーター
├── BaseAgent.ts               # 基底クラス
├── ProperNounsAgent.ts        # 固有名詞
├── NumbersStatsAgent.ts       # 数値・統計
├── DatesTimelineAgent.ts      # 日付・時系列
├── FactsCasesAgent.ts         # 事例・ファクト
├── CompanyAgent.ts            # 自社サービス専門
├── CitationsAgent.ts          # 引用・出典検証
├── TechnicalAgent.ts          # 技術仕様
├── LegalAgent.ts              # 法令・規制
├── SourceRequirementAgent.ts  # 出典必要性判定
├── SourceEnhancementAgent.ts  # 出典検索
├── IntegrationAgent.ts        # 最終統合
└── types.ts                   # 型定義
```

### コスト比較

#### マルチエージェント版（実装済み）
- **フェーズ1（並列）**: 約10-15秒
- **フェーズ2（順次）**: 約35-70秒（Web検索含む）
- **フェーズ3（統合）**: 約4-5秒
- **合計処理時間**: 約50-90秒
- **API料金**: 約20-25円/記事（Web検索の頻度による）

### メリット
1. **タイムアウト回避**: 並列処理により全体時間短縮
2. **透明性向上**: 各チェック項目の個別結果が明確
3. **柔軟性**: 必要なエージェントのみ実行可能
4. **精度向上**: 各分野に特化した検証
5. **デバッグ容易性**: 問題のあるエージェントを特定しやすい

### デメリット
1. **コスト増加**: 約10倍のAPI料金
2. **実装複雑性**: 並列処理の制御が必要
3. **エラーハンドリング**: 複数エージェントの失敗パターン対応

### 使用方法
```typescript
import { MultiAgentOrchestrator } from './services/finalProofreadingAgents/MultiAgentOrchestrator';

// オーケストレーター初期化
const orchestrator = new MultiAgentOrchestrator({
  enableLegalCheck: false,  // 法令チェックの有効/無効
  parallel: true,           // 並列実行
  onProgress: (message, progress) => {
    console.log(`進捗: ${progress}% - ${message}`);
  }
});

// 実行
const result = await orchestrator.execute(articleContent);
console.log('総合スコア:', result.overallScore);
console.log('合否判定:', result.overallScore >= 75 ? '合格' : '要修正');
```

## 執筆エージェント以降の全レギュレーション

### 執筆エージェント（writingAgentV3.ts）の必須ルール

#### 基本設定
- **使用AI**: Gemini 2.5 Pro（Grounding機能有効）
- **文体**: です・ます調、断定は根拠とセット
- **対象読者**: 法人の決裁者・推進担当・現場マネジャー

#### 文章構成ルール
1. **リード文（導入）**
   - 200-350字
   - 悩みの代弁→解決策→読むベネフィット→読み進め促し
   - 自社サービス認知を自然に1文挿入

2. **段落構成**
   - 1段落2-4文
   - 平均文長40-60字（最大80字）
   - 段落開始：要点一句（結論/ベネフィット）
   - 段落終了：次段落へのブリッジ一句

3. **論理展開**
   - PREP法使用（連打禁止）
   - SDS法、Q→A→Why→How（用途で使い分け）
   - H2冒頭2文で見出しテーマの答えを明示

4. **強調・装飾**
   - `<b>`タグで重要部分強調
   - 各見出しの結論文、数値・条件・判断基準
   - 1見出しあたり1-3箇所

5. **禁止事項**
   - 同型文末3連続
   - 抽象的な一般論の羅列
   - 婉曲表現の多用
   - 工程やメタ説明の出力

### 執筆チェックエージェント（writingCheckerV3.ts）の評価基準

#### チェック項目
1. **文法・表記**
   - 誤字脱字
   - 助詞の適切性
   - 表記統一（全角/半角、送り仮名）

2. **SEOコンプライアンス**
   - キーワードスタッフィング回避
   - 隠しテキスト・リンクなし
   - Core Web Vitals考慮

3. **可読性**
   - 文章難易度（中学生レベル）
   - 段落長（3-5文推奨）
   - 見出し間隔（300-400字）

4. **事実確認**
   - 統計・数値の正確性
   - 引用元の信頼性
   - YMYL準拠（該当する場合）

5. **法的・倫理的**
   - 著作権侵害リスク
   - 薬機法・景表法準拠
   - 差別的表現の排除

### 最終校閲エージェント（finalProofreadingAgent.ts）の要件

#### GPT-5 + Responses API仕様
- モデル：gpt-5-mini推奨
- Web検索ツール使用（日本語ソース優先）
- reasoning.effort: high

#### ファクトチェック重点項目
1. **必須確認事項**
   - 固有名詞（企業/製品/人物）
   - 数値（性能/価格/シェア）
   - 日付・期間
   - ランキング・最上級表現

2. **自社サービス関連**
   - 自社実績は外部裏取り不要
   - 実績数値の正確性確認
   - 企業名と成果の対応確認

3. **出典管理**
   - 記事内：アクセス日なし
   - 内部レポート：アクセス日記録
   - 一次情報優先

### 修正判定フロー（人間介在型）

```
1. 執筆エージェントが記事を生成
   ↓
2. 最終校閲マルチエージェント（1-9）が1回チェック実施
   ↓
3. 最終統合エージェントが結果統合・評価
   ↓
4. 評価結果と修正案を画面表示
   - 総合スコア（100点満点）
   - 各エージェントの指摘事項
   - 修正提案（優先順位付き）
   ↓
5. 人間が確認して判断
   - 80点以上 → そのまま公開可能
   - 80点未満 → 修正ボタンで修正実行
   ↓
6. 修正ボタンを押した場合のみ修正適用
```

### チェックは1回のみ

- **自動リトライなし**: 人間の判断を必須とする
- **無限ループの心配なし**: 1回のチェックで完結
- **修正の透明性**: すべての修正内容を事前確認可能

### 修正指示の優先順位

1. **Critical（即座に修正）**
   - 事実誤認
   - 法的リスク
   - SEO致命的欠陥

2. **High（必須修正）**  
   - 構成ルール違反
   - キーワード密度異常
   - 文体不統一

3. **Medium（推奨修正）**
   - 可読性向上
   - 表現の改善
   - 構造の最適化

4. **Low（任意修正）**
   - 微細な表記調整
   - スタイルの統一