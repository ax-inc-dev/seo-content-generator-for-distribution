<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ¨ ç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 40px;
        max-width: 800px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
        text-align: center;
        font-size: 2em;
      }

      .article-info {
        background: #f7f7f7;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }

      .article-info h2 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .info-row {
        margin: 10px 0;
        padding: 10px;
        background: white;
        border-radius: 5px;
      }

      .info-label {
        font-weight: bold;
        color: #666;
      }

      .status {
        text-align: center;
        padding: 20px;
        background: #e3f2fd;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .status.loading {
        background: #fff3e0;
      }

      .status.success {
        background: #e8f5e9;
      }

      .status.error {
        background: #ffebee;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 10px;
        font-size: 1.1em;
        cursor: pointer;
        width: 100%;
        transition: transform 0.2s;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .content-preview {
        background: #f5f5f5;
        padding: 20px;
        border-radius: 10px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¨ ç”»åƒç”Ÿæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</h1>

      <div class="status" id="status">è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

      <div class="article-info" id="articleInfo" style="display: none">
        <h2>ğŸ“„ è¨˜äº‹æƒ…å ±</h2>
        <div class="info-row">
          <span class="info-label">ã‚¿ã‚¤ãƒˆãƒ«:</span>
          <span id="articleTitle">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</span>
          <span id="articleKeyword">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">ãƒ¡ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³:</span>
          <span id="articleMeta">-</span>
        </div>
      </div>

      <button id="generateBtn" onclick="generateImages()" disabled>
        ğŸš€ ç”»åƒã‚’ç”Ÿæˆã™ã‚‹
      </button>

      <div class="content-preview" id="contentPreview" style="display: none">
        <h3>è¨˜äº‹å†…å®¹ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</h3>
        <div id="contentText"></div>
      </div>
    </div>

    <script>
      let articleData = null;

      // postMessageã§ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡
      window.addEventListener("message", (event) => {
        console.log("ğŸ“¨ postMessageå—ä¿¡:", event);

        if (
          event.data &&
          (event.data.type === "ARTICLE_DATA" ||
            event.data.type === "ARTICLE_DATA_TRANSFER")
        ) {
          console.log("âœ… è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã¾ã—ãŸ");
          console.log("  å—ä¿¡ãƒ‡ãƒ¼ã‚¿:", event.data.data);
          console.log(
            "  htmlContent:",
            event.data.data.htmlContent ? "ã‚ã‚Š" : "ãªã—"
          );
          articleData = event.data.data;
          displayArticleInfo();
          document.getElementById("status").textContent =
            "âœ… è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ";
          document.getElementById("status").className = "status success";
          document.getElementById("generateBtn").disabled = false;
        }
      });

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      window.addEventListener("load", () => {
        try {
          // localStorageã‹ã‚‰è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const storedData = localStorage.getItem(
            "articleDataForImageGen_5176"
          );

          if (storedData) {
            articleData = JSON.parse(storedData);
            displayArticleInfo();
            document.getElementById("status").textContent =
              "âœ… è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ";
            document.getElementById("status").className = "status success";
            document.getElementById("generateBtn").disabled = false;
          } else {
            document.getElementById("status").textContent =
              "âš ï¸ è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‹ã‚‰ã€Œç”»åƒç”Ÿæˆã¸ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
            document.getElementById("status").className = "status error";
          }
        } catch (error) {
          console.error("Error loading article data:", error);
          document.getElementById("status").textContent =
            "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
          document.getElementById("status").className = "status error";
        }
      });

      function displayArticleInfo() {
        if (!articleData) return;

        document.getElementById("articleInfo").style.display = "block";
        document.getElementById("articleTitle").textContent =
          articleData.title || "-";
        document.getElementById("articleKeyword").textContent =
          articleData.keyword || "-";
        document.getElementById("articleMeta").textContent =
          articleData.metaDescription || "-";

        // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        if (articleData.htmlContent) {
          document.getElementById("contentPreview").style.display = "block";
          // HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã®ã¿è¡¨ç¤ºï¼ˆæœ€åˆã®500æ–‡å­—ã®ã¿ï¼‰
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = articleData.htmlContent;
          const textContent = tempDiv.textContent || tempDiv.innerText || "";
          document.getElementById("contentText").textContent =
            textContent.length > 500
              ? textContent.substring(0, 500) + "..."
              : textContent;
        } else {
          console.warn("âš ï¸ htmlContentãŒç©ºã§ã™");
        }
      }

      async function generateImages() {
        if (!articleData) {
          alert("è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
          return;
        }

        const btn = document.getElementById("generateBtn");
        const status = document.getElementById("status");

        btn.disabled = true;
        btn.innerHTML = 'è»¢é€ä¸­... <span class="loading-spinner"></span>';
        status.textContent = "ğŸ”„ AI Article Imager for WordPressã«è»¢é€ä¸­...";
        status.className = "status loading";

        try {
          // ç’°å¢ƒã«å¿œã˜ãŸURLè¨­å®š
          const isLocalhost =
            window.location.hostname === "localhost" ||
            window.location.hostname === "127.0.0.1";
          // ç’°å¢ƒã«å¿œã˜ãŸURLã‚’è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã®å ´åˆã¯ç’°å¢ƒå¤‰æ•°ã§è¨­å®šï¼‰
          const imageGenUrl = isLocalhost
            ? "http://localhost:5177"
            : "http://localhost:5177"; // æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã¯ã“ã“ã‚’å¤‰æ›´

          console.log("ğŸš€ è»¢é€ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:", {
            title: articleData.title,
            htmlContent: articleData.htmlContent ? "ã‚ã‚Š" : "ãªã—",
            keyword: articleData.keyword,
            metaDescription: articleData.metaDescription,
            slug: articleData.slug || "auto-generated",
          });

          // æ–°ã—ã„ã‚¿ãƒ–ã§ai-article-imager-for-wordpressã‚’é–‹ã
          const newWindow = window.open(imageGenUrl, "_blank");

          if (newWindow) {
            // ãƒ‡ãƒ¼ã‚¿ã‚’è»¢é€
            setTimeout(() => {
              const transferData = {
                type: "ARTICLE_DATA",
                data: {
                  title: articleData.title,
                  htmlContent: articleData.htmlContent,
                  keyword: articleData.keyword,
                  metaDescription: articleData.metaDescription,
                  slug: articleData.slug || "auto-generated",
                },
              };

              console.log("ğŸ“¤ å®Ÿéš›ã«è»¢é€ã™ã‚‹ãƒ‡ãƒ¼ã‚¿:", transferData);

              const targetOrigin = isLocalhost
                ? "http://localhost:5177"
                : "http://localhost:5177"; // æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã¯ã“ã“ã‚’å¤‰æ›´

              console.log("ğŸ“¤ é€ä¿¡å…ˆã‚ªãƒªã‚¸ãƒ³:", targetOrigin);

              newWindow.postMessage(transferData, targetOrigin);

              status.textContent =
                "âœ… AI Article Imager for WordPressã«è»¢é€å®Œäº†ï¼æ–°ã—ã„ã‚¿ãƒ–ã§ç”»åƒç”Ÿæˆã‚’ç¶šè¡Œã—ã¦ãã ã•ã„ã€‚";
              status.className = "status success";
              btn.innerHTML = "ğŸš€ å†åº¦è»¢é€ã™ã‚‹";
              btn.disabled = false;

              console.log(
                "ğŸ“¤ è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’AI Article Imager for WordPressã«è»¢é€ã—ã¾ã—ãŸ"
              );
            }, 2000);
          } else {
            throw new Error(
              "AI Article Imager for WordPressã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            );
          }
        } catch (error) {
          console.error("è»¢é€ã‚¨ãƒ©ãƒ¼:", error);
          status.textContent = "âŒ è»¢é€ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message;
          status.className = "status error";
          btn.innerHTML = "ğŸš€ ç”»åƒã‚’ç”Ÿæˆã™ã‚‹";
          btn.disabled = false;
        }
      }
    </script>
  </body>
</html>
