# 📝 記事執筆エージェント ワークフロー

## 🎯 概要
構成案から実際の記事本文を生成する執筆エージェントの動作フロー

## 📊 実行方式

### 1. **標準生成方式** (`articleWriterService.ts`)
一括で記事全体を生成

### 2. **セクション単位生成方式** (`sectionBasedArticleWriter.ts`) 
セクションごとに個別生成（デフォルト）

---

## 🔄 執筆ワークフロー

### Phase 1: 初期設定と分析
```
入力: SeoOutline（構成案）
↓
1. 目標文字数の確認
   - outline.characterCountAnalysis.average から取得
   - デフォルト: 30,000文字
   
2. 文字数配分の計算
   - リード文: 300-500文字（全体の2-3%、最大500文字）
   - まとめ: 400-1500文字（全体の5-8%）
   - 本文: 残りを各セクションに配分
   
3. セクション重要度の判定
   - キーワード関連性スコア（1.0-1.5）
   - 位置による調整（最初は1.2倍、最後は0.8倍）
   - 内容による調整（「とは」は1.3倍、「まとめ」は0.7倍）
```

### Phase 2: 頻出単語の準備
```
4. 競合分析データから頻出単語を抽出
   - 必須単語: articleCount >= 10の単語（上位10個）
   - 推奨単語: articleCount >= 5の単語（上位15個）
   
5. 頻出単語指示文の生成
   - 必須単語は「自然に複数回使用」
   - 推奨単語は「適切に配置」
```

### Phase 3: プロンプト構築
```
6. 執筆指示の組み立て
   
【基本情報】
- キーワード: 記事のメインキーワード
- ターゲット読者: outline.targetAudience
- 目標文字数: 明確に指定

【構成詳細】
- 各H2見出しと目標文字数
- H3見出しと執筆指示（writingNote）
- 画像提案（imageSuggestion）

【執筆ルール】
1. PREP法で論理的に構成（ラベル付けは不要）
2. リード文で読者の悩みに寄り添う
3. 一文一意の原則
4. 語尾の3回以上の繰り返し禁止
5. 専門用語には出典明記
6. 段落分けを適切に
7. 「結論」「理由」などのラベル禁止

【WordPress用HTML形式】
- 使用可能: h2, h3, p, strong, ul, ol, li, blockquote
- 使用禁止: 
  - article, section, h1タグ
  - HTMLコメント
  - インデント
  - H2への番号付け
  - コードブロック記法（```）
```

### Phase 4-A: 標準生成（一括方式）
```
7. Gemini API呼び出し
   - モデル: gemini-2.0-flash-exp
   - temperature: 0.7
   - maxOutputTokens: 60000
   
8. 記事全体を一度に生成
```

### Phase 4-B: セクション単位生成（推奨）
```
7. リード文の生成
   - 目標: 300-500文字
   - 読者の悩みへの共感
   - 記事で得られる価値の提示
   
8. 各セクションの順次生成
   for each section:
     - 文脈情報の引き継ぎ（前セクションの要約）
     - 重複する例の回避
     - 目標文字数に合わせた生成
     - 実際の文字数をトラッキング
   
9. まとめセクションの生成
   - 全セクションの要点を踏まえる
   - 行動を促す締めくくり
```

### Phase 5: 推敲処理
```
10. 文字数チェック
    - 目標との乖離を計算
    - 20%以上の不足があれば追記

11. 推敲プロンプトで調整（不足時のみ）
    - 不足セクションの特定
    - 具体例や詳細説明の追加
    - 目標文字数への調整

12. 最終処理
    - コードブロック記法の除去
    - HTMLタグのクリーンアップ
    - 不要なインデントの削除
```

### Phase 6: 出力生成
```
13. 記事データの構築
    {
      title: 記事タイトル,
      metaDescription: メタディスクリプション,
      htmlContent: WordPress用HTML,
      plainText: プレーンテキスト版,
      proofreadingInfo: 推敲情報（文字数調整の詳細）
    }
```

---

## 🎯 品質管理ポイント

### 文字数管理
- **セクション単位方式**: 各セクションで目標を設定し、累積誤差を防ぐ
- **推敲機能**: 20%以上の不足時に自動追記
- **トークン管理**: maxOutputTokens=60000で十分な生成量を確保

### コンテンツ品質
- **PREP法**: 論理的構成（Point→Reason→Example→Point）
- **頻出単語**: 競合上位サイトの重要キーワードを自然に配置
- **一文一意**: 読みやすさの確保
- **語尾変化**: 単調さの回避

### WordPress互換性
- **クリーンHTML**: 余計なタグやコメントを排除
- **コピペ対応**: そのまま投稿エディタに貼り付け可能
- **構造保持**: H2/H3の階層構造を正確に維持

---

## 📈 最適化のポイント

1. **セクション単位生成を推奨**
   - 文字数制御が正確
   - 文脈の一貫性を保持
   - エラー時の部分再生成が可能

2. **重要度に応じた配分**
   - キーワード関連セクションに多く配分
   - まとめは簡潔に

3. **頻出単語の活用**
   - SEO効果の向上
   - 競合との関連性確保

4. **推敲による品質向上**
   - 文字数の自動調整
   - 内容の充実化